---
import { randomUUID } from 'node:crypto';

const {
  id = randomUUID(),
  heading,
  description
} = Astro.props as {
  id?: string;
  heading?: string;
  description?: string;
};

const hasCode = Astro.slots.has('code');
const hasScript = Astro.slots.has('script');
const summaryLabel = hasCode ? 'View source' : undefined;
---
<section class="playground" aria-labelledby={heading ? `${id}-heading` : undefined}>
  <div class="playground__header">
    {heading && (
      <div id={`${id}-heading`} class="playground__title">{heading}</div>
    )}
    {description && <p class="playground__description">{description}</p>}
    <div class="playground__actions">
      {hasCode && (
        <button
          type="button"
          class="playground__action"
          data-playground-action="code"
          data-playground-id={id}
          aria-pressed="false"
        >
          {summaryLabel}
        </button>
      )}
      <button type="button" class="playground__action" data-playground-action="reset" data-playground-id={id}>
        Reset
      </button>
    </div>
  </div>
  <div class="playground__body">
    <div class="playground__preview" data-playground-preview={id}>
      <slot name="demo" />
    </div>
    {hasCode && (
      <pre class="playground__code" data-playground-code={id} hidden>
        <code>
          <slot name="code" />
        </code>
      </pre>
    )}
  </div>
  {hasScript && <slot name="script" />}
  <script is:inline type="module">
    (() => {
      const sections = Array.from(document.querySelectorAll('section.playground'));
      if (sections.length === 0) return;

      let libraryPromise;
      const ensureLibrary = () => {
        const w = window;
        if (w.automagica11y) return Promise.resolve(w.automagica11y);
        if (libraryPromise) return libraryPromise;
        // Fallback: load the prebuilt IIFE from /dist and bridge the global
        libraryPromise = new Promise((resolve, reject) => {
          const existing = document.querySelector('script[data-a11y-lib]');
          if (existing) {
            existing.addEventListener('load', () => {
              if (!w.automagica11y && w.automagicA11y) w.automagica11y = w.automagicA11y;
              resolve(w.automagica11y);
            }, { once: true });
            existing.addEventListener('error', reject, { once: true });
            return;
          }
          const s = document.createElement('script');
          s.src = '/dist/automagica11y.min.js';
          s.async = true;
          s.defer = true;
          s.setAttribute('data-a11y-lib', '');
          s.onload = () => {
            if (!w.automagica11y && w.automagicA11y) w.automagica11y = w.automagicA11y;
            resolve(w.automagica11y);
          };
          s.onerror = reject;
          document.head.appendChild(s);
        });
        return libraryPromise;
      };

      for (const section of sections) {
        const preview = section.querySelector('[data-playground-preview]');
        if (!preview) continue;
        const id = preview.getAttribute('data-playground-preview') || '';
        const code = section.querySelector('[data-playground-code]');
        const actions = section.querySelectorAll('[data-playground-id]');
        const initial = preview.innerHTML;

        const dispatchInit = () => {
          ensureLibrary()
            .then(({ initNode }) => {
              if (typeof initNode === 'function') {
                initNode(preview);
              }
              const event = new CustomEvent('automagica11y:playground:init', {
                detail: { id, container: preview }
              });
              document.dispatchEvent(event);
            })
            .catch((err) => {
              console.error('[docs/playground] Failed to load automagica11y', err);
            });
        };

        const toggleCode = (action) => {
          if (!code) return;
          const expanded = !code.hasAttribute('hidden');
          code.toggleAttribute('hidden', expanded);
          const nowExpanded = !code.hasAttribute('hidden');
          action.setAttribute('aria-pressed', nowExpanded ? 'true' : 'false');
          action.setAttribute('aria-expanded', nowExpanded ? 'true' : 'false');
          action.textContent = nowExpanded ? 'Hide source' : 'View source';
        };

        actions.forEach((action) => {
          action.addEventListener('click', () => {
            const mode = action.getAttribute('data-playground-action');
            if (mode === 'code') {
              toggleCode(action);
              return;
            }

            if (mode === 'reset') {
              preview.innerHTML = initial;
              if (code) {
                code.setAttribute('hidden', '');
              }
              if (code && actions.length > 1) {
                actions.forEach(btn => {
                  if (btn.getAttribute('data-playground-action') === 'code') {
                    btn.setAttribute('aria-pressed', 'false');
                    btn.setAttribute('aria-expanded', 'false');
                    btn.textContent = 'View source';
                  }
                });
              }
              dispatchInit();
            }
          });
        });

        dispatchInit();
      }
    })();
  </script>
</section>

<style>
  .playground {
    border: 1px solid var(--docs-border-soft);
    border-radius: var(--docs-radius-lg);
    padding: var(--docs-spacing-lg);
    margin: var(--docs-spacing-xl) 0;
    background: var(--docs-bg);
    box-shadow: var(--docs-shadow-md);
  }

  .playground__header {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: var(--sl-spacing-md);
    margin-bottom: var(--sl-spacing-md);
  }

  .playground__title {
    font-weight: 600;
    font-size: var(--sl-text-lg);
  }

  .playground__description {
    margin: 0;
    color: var(--sl-color-text-muted);
    flex: 1 1 100%;
  }

  .playground__actions {
    display: flex;
    gap: var(--sl-spacing-sm);
  }

  .playground__action {
    border: 1px solid var(--docs-border-soft);
    border-radius: var(--sl-border-radius-sm);
    padding: 0.35rem 0.75rem;
    background: var(--sl-color-bg);
    color: var(--sl-color-text);
    font-size: var(--sl-text-sm);
    cursor: pointer;
  }
  .playground__action:hover {
    background: var(--docs-bg-soft);
  }

  .playground__body {
    display: grid;
    gap: var(--sl-spacing-md);
  }

  .playground__preview {
    padding: var(--sl-spacing-md);
    background: var(--docs-code-bg);
    border-radius: var(--docs-radius-md);
    border: 1px dashed var(--docs-preview-border);
  }

  .playground__code {
    overflow-x: auto;
    background: var(--docs-bg-soft);
    border-radius: var(--docs-radius-md);
    padding: var(--docs-spacing-md);
  }

  @media (max-width: 720px) {
    .playground {
      padding: var(--sl-spacing-md);
    }

    .playground__preview {
      padding: var(--sl-spacing-sm);
    }
  }
</style>
